#!/bin/bash

PROJECT_DIR=$(pwd)
PROJECT_NAME=$(basename $PROJECT_DIR)

# kill any existing session for this project
tmux has-session -t $PROJECT_NAME &> /dev/null
if [ $? == 0 ] ; then
  tmux kill-session $PROJECT_NAME
fi

# create session
LAST_MODIFIED_FILE=$(find . -name "*.clj" | xargs ls -1t | head -n1 | sed 's/\.\///')
tmux new-session -d -s $PROJECT_NAME
tmux rename-window "$PROJECT_NAME-CODE"
tmux send-keys "cd $PROJECT_DIR; reattach-to-user-namespace -l vim $LAST_MODIFIED_FILE" C-m C-m

# start nrepl
tmux new-window -n "$PROJECT_NAME-REPL" "cd $PROJECT_DIR && lein repl"

# start in vim's window
tmux select-window -t "$PROJECT_NAME-CODE"

# setup project-specific bindings
tmux bind r select-window -t "$PROJECT_NAME-REPL"
tmux bind t select-window -t "$PROJECT_NAME-TESTS"
tmux bind c select-window -t "$PROJECT_NAME-CODE"

tmux attach-session -t $PROJECT_NAME
